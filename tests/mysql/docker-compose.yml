# Variable substitution
# https://docs.docker.com/compose/compose-file/compose-file-v3/#variable-substitution
# 環境変数は backends/test/containers/Makefile で設定されています。
name: "querybm-mysql-test"
services:
  mysql:
    image: mysql:9.3.0
    hostname: mysql
    restart: always
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
      MYSQL_ROOT_HOST: "%"
    ports:
      - "${MYSQL_PORT}:3306"
    volumes:
      - ./conf.d:/etc/mysql/conf.d
    networks:
      - network1

  wait4x:
    image: wait4x/wait4x:latest
    command:
      - mysql
      - "root@tcp(mysql:${MYSQL_PORT})/${MYSQL_DATABASE}"
    depends_on:
      - mysql
    networks:
      - network1

  migration:
    image: mysql:9.3.0
    command:
      - /bin/bash
      - "-c"
      - "mysql -h mysql -P ${MYSQL_PORT} ${MYSQL_DATABASE} < /schema.sql"
    volumes:
      - ./schema.sql:/schema.sql
    depends_on:
      wait4x:
        condition: service_completed_successfully
    networks:
      - network1

networks:
  network1:
